files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99-check-app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # Check if the app is running
      if curl -s http://localhost:5000/actuator/health | grep -q "UP"; then
        echo "Application is running correctly"
      else
        echo "Application failed to start. Checking database connectivity..."
        # Test database connectivity
        java -cp /var/app/current/target/product_demo-0.0.1-SNAPSHOT.jar org.springframework.boot.loader.JarLauncher --spring.profiles.active=prod org.springframework.boot.SpringApplication --spring.main.web-application-type=none --logging.level.root=INFO --spring.datasource.url=jdbc:oracle:thin:@//demo-oracle.clk6uoay0fb3.ap-southeast-2.rds.amazonaws.com:1521/DEMOORCL --spring.datasource.username=${DB_USERNAME} --spring.datasource.password=${DB_PASSWORD} org.springframework.jdbc.datasource.init.ScriptUtils "SELECT 1 FROM DUAL"
      fi

      # Check application logs for errors
      echo "Recent application logs:"
      tail -n 100 /var/log/web.stdout.log